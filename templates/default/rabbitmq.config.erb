%%%
%% Generated by Chef
%%%

[
  {rabbit, [
<% if node['rabbitmq']['cluster'] && node['rabbitmq']['cluster_disk_nodes'] -%>
    {cluster_nodes, [<%= node['rabbitmq']['cluster_disk_nodes'].map{|n| "\'#{n}\'"}.join(',') %>]},
<% end %>
<% if node[:rabbitmq][:disk_free_limit] %>
   {disk_free_limit, <%= node[:rabbitmq][:disk_free_limit] %>},
<% end %>
<% if node[:rabbitmq][:federate] && node[:rabbitmq][:upstream_connections] -%>
{rabbitmq_federation,
   [
    {exchanges, [[{exchange, "main"},
                  {type, "topic"},
                  {upstream_set, "tomcats"}]]},
    {upstream_sets, [{"tomcats", [
                                  <% node[:rabbitmq][:upstream_connections].each_with_index do |connection, index| %>
                                  [
                                   {connection, "<%= connection[:name] %>"},
                                   {exchange, "upstream"},
                                   {max_hops, 1}
                                  ]<% if index != node[:rabbitmq][:upstream_connections].length - 1 -%>,<% end %>
                                  <% end %>
                                 ]
                     }]},
    {connections, [
                   <% node[:rabbitmq][:upstream_connections].each_with_index do |connection, index| %>
                   {"<%= connection[:name] %>", [{host, "<%= connection[:host] %>"},
                                               {port, 5672}]}<% if index != node[:rabbitmq][:upstream_connections].length - 1 -%>,<% end %>
                   <% end %>
                  ]}
   ]
},
<% end %>
<% if node['rabbitmq']['ssl'] -%>
    {ssl_listeners, [<%= node['rabbitmq']['ssl_port'] %>]},
    {ssl_options, [{cacertfile,"<%= node['rabbitmq']['ssl_cacert'] %>"},
                    {certfile,"<%= node['rabbitmq']['ssl_cert'] %>"},
                    {keyfile,"<%= node['rabbitmq']['ssl_key'] %>"},
                    {verify,verify_none},
                    {fail_if_no_peer_cert,false}]},
<% end %>
    {default_user, <<"<%= node['rabbitmq']['default_user'] %>">>},
    {default_pass, <<"<%= node['rabbitmq']['default_pass'] %>">>}
  ]}
].
